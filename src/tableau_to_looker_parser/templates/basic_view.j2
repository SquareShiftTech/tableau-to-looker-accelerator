view: {{ view_name }} {
  # Generated from Tableau view: {{ view.original_name if view.original_name else view.name }}

  {% if table_name %}
  sql_table_name: {{ table_name }} ;;
  {% endif %}

  {% if view.description %}
  description: "{{ view.description }}"
  {% endif %}

  # Date dimension groups
  {% if has_dimensions %}
  {% for dimension in dimensions %}
  {% if dimension.field_type == 'date' or dimension.field_type == 'datetime' or dimension.field_type == 'time' %}

  dimension_group: {{ dimension.name | clean_name }} {
    type: time
    timeframes: [raw, time, date, week, month, quarter, year]
    sql: ${TABLE}.{{ (dimension.sql_column or dimension.name) | sql_column }} ;;
    {% if dimension.description %}
    description: "{{ dimension.description | escape_quotes }}"
    {% endif %}
    {% if dimension.hidden %}
    hidden: yes
    {% endif %}
    {% if dimension.label %}
    label: "{{ dimension.label | escape_quotes }}"
    {% endif %}
  }
  {% endif %}
  {% endfor %}
  {% endif %}

  # Dimensions
  {% if has_dimensions %}
  {% for dimension in dimensions %}
  {% if not (dimension.field_type == 'date' or dimension.field_type == 'datetime' or dimension.field_type == 'time') %}

  dimension: {{ dimension.name | clean_name }} {
    {% if dimension.description %}
    description: "{{ dimension.description | escape_quotes }}"
    {% endif %}
    {% if dimension.field_type == 'string' %}
    type: string
    {% elif dimension.field_type == 'integer' %}
    type: number
    {% elif dimension.field_type == 'real' %}
    type: number
    {% elif dimension.field_type == 'boolean' %}
    type: yesno
    {% else %}
    type: string
    {% endif %}
    {% if dimension.sql_column %}
    sql: ${TABLE}.{{ dimension.sql_column | sql_column }} ;;
    {% else %}
    sql: ${TABLE}.{{ dimension.name | sql_column }} ;;
    {% endif %}
    {% if dimension.hidden %}
    hidden: yes
    {% endif %}
    {% if dimension.label %}
    label: "{{ dimension.label | escape_quotes }}"
    {% endif %}
    {% if dimension.group_label %}
    group_label: "{{ dimension.group_label | escape_quotes }}"
    {% endif %}
  }
  {% endif %}
  {% endfor %}
  {% endif %}

  # Two-step Pattern Dimensions (hidden calculation dimensions)
  {% if has_calculated_dimensions %}
  {% for calc_dim in calculated_dimensions %}

  dimension: {{ calc_dim.name }} {
    description: "{{ calc_dim.description | escape_quotes }}"
    type: {{ calc_dim.lookml_type }}
    sql: {{ calc_dim.sql }} ;;
    hidden: yes
    {% if calc_dim.migration_error %}
    # {{ calc_dim.migration_comment | single_line_comment }}
    {% elif calc_dim.original_formula %}
    # Original Tableau formula: {{ calc_dim.original_formula | single_line_comment }}
    {% endif %}
  }
  {% endfor %}
  {% endif %}

  # Calculated Fields (from Tableau formulas)
  {% if has_calculated_fields %}
  {% for calc_field in calculated_fields %}

  {% if calc_field.role == 'dimension' or calc_field.field_type == 'dimension' %}
  dimension: {{ calc_field.name }} {
    description: "{{ calc_field.description | escape_quotes }}"
    {% if calc_field.datatype == 'string' %}
    type: string
    {% elif calc_field.datatype == 'integer' %}
    type: number
    {% elif calc_field.datatype == 'real' %}
    type: number
    {% elif calc_field.datatype == 'boolean' %}
    type: yesno
    {% else %}
    type: string
    {% endif %}
    sql: {{ calc_field.sql }} ;;
    {% if calc_field.migration_error %}
    # {{ calc_field.migration_comment | single_line_comment }}
    {% elif calc_field.original_formula %}
    # Original Tableau formula: {{ calc_field.original_formula | single_line_comment }}
    {% endif %}
  }
  {% else %}
  measure: {{ calc_field.name }} {
    description: "{{ calc_field.description | escape_quotes }}"
    {% if calc_field.is_two_step_measure %}
    type: number
    sql: ${{ '{' + calc_field.references_dimension + '}' }} ;;
    {% elif calc_field.lookml_type %}
    type: number
    sql: {{ calc_field.sql }} ;;
    {% elif calc_field.datatype == 'integer' or calc_field.datatype == 'real' %}
    type: number
    sql: {{ calc_field.sql }} ;;
    {% else %}
    type: number
    sql: {{ calc_field.sql }} ;;
    {% endif %}
    {% if calc_field.migration_error %}
    # {{ calc_field.migration_comment | single_line_comment }}
    {% elif calc_field.original_formula %}
    # Original Tableau formula: {{ calc_field.original_formula | single_line_comment }}
    {% endif %}
  }
  {% endif %}
  {% endfor %}
  {% endif %}

  # Measures
  {% if has_measures %}
  {% for measure in measures %}

  measure: {{ measure.name | clean_name }} {
    {% if measure.description %}
    description: "{{ measure.description | escape_quotes }}"
    {% endif %}
    {% if measure.dimension_reference %}
    {# Two-step pattern: measure references hidden dimension #}
    type: {{ measure.aggregation.value if measure.aggregation.value else 'sum' }}
    sql: ${ {{- measure.dimension_reference -}} } ;;
    {% else %}
    {# Legacy pattern: measure references table column directly #}
    type: number
    sql: ${TABLE}.{{ (measure.sql_column or measure.name) | sql_column }} ;;
    {% endif %}
    {% if measure.value_format %}
    value_format: "{{ measure.value_format }}"
    {% endif %}
    {% if measure.hidden %}
    hidden: yes
    {% endif %}
    {% if measure.label %}
    label: "{{ measure.label | escape_quotes }}"
    {% endif %}
    {% if measure.group_label %}
    group_label: "{{ measure.group_label | escape_quotes }}"
    {% endif %}
    {% if measure.drill_fields %}
    drill_fields: [{{ measure.drill_fields | join(', ') }}]
    {% endif %}
  }
  {% endfor %}
  {% endif %}


}
