view: {{ view_name }} {
  # Generated from Tableau view: {{ view.original_name if view.original_name else view.name }}

  {% if table_name %}
  sql_table_name: {{ table_name }} ;;
  {% endif %}

  {% if view.description %}
  description: "{{ view.description }}"
  {% endif %}

  # Dimensions
  {% if has_dimensions %}
  {% for dimension in dimensions %}

  dimension: {{ dimension.name | clean_name }} {
    {% if dimension.description %}
    description: "{{ dimension.description | escape_quotes }}"
    {% endif %}
    {% if dimension.field_type == 'string' %}
    type: string
    {% elif dimension.field_type == 'integer' %}
    type: number
    {% elif dimension.field_type == 'real' %}
    type: number
    {% elif dimension.field_type == 'date' %}
    type: date
    {% elif dimension.field_type == 'datetime' %}
    type: datetime
    {% elif dimension.field_type == 'time' %}
    type: time
    {% elif dimension.field_type == 'boolean' %}
    type: yesno
    {% else %}
    type: string
    {% endif %}
    sql: ${TABLE}.{{ (dimension.sql_column or dimension.name) | sql_column }} ;;
    {% if dimension.hidden %}
    hidden: yes
    {% endif %}
    {% if dimension.label %}
    label: "{{ dimension.label | escape_quotes }}"
    {% endif %}
    {% if dimension.group_label %}
    group_label: "{{ dimension.group_label | escape_quotes }}"
    {% endif %}
  }
  {% endfor %}

  # Date dimension groups
  {% for dimension in dimensions %}
  {% if dimension.type == 'date' or dimension.type == 'datetime' %}

  dimension_group: {{ dimension.name | clean_name }} {
    type: time
    timeframes: [raw, time, date, week, month, quarter, year]
    sql: ${TABLE}.{{ (dimension.sql_column or dimension.name) | sql_column }} ;;
    {% if dimension.description %}description: "{{ dimension.description | escape_quotes }}"{% endif %}
    {% if dimension.hidden %}hidden: yes{% endif %}
  }
  {% endif %}
  {% endfor %}
  {% endif %}

  # Two-step Pattern Dimensions (hidden calculation dimensions)
  {% if has_calculated_dimensions %}
  {% for calc_dim in calculated_dimensions %}

  dimension: {{ calc_dim.name }} {
    description: "{{ calc_dim.description | escape_quotes }}"
    type: {{ calc_dim.lookml_type }}
    sql: {{ calc_dim.sql }} ;;
    hidden: yes
    {% if calc_dim.migration_error %}
    # {{ calc_dim.migration_comment | single_line_comment }}
    {% elif calc_dim.original_formula %}
    # Original Tableau formula: {{ calc_dim.original_formula | single_line_comment }}
    {% endif %}
  }
  {% endfor %}
  {% endif %}

  # Calculated Fields (from Tableau formulas)
  {% if has_calculated_fields %}
  {% for calc_field in calculated_fields %}

  {% if calc_field.role == 'dimension' or calc_field.field_type == 'dimension' %}
  dimension: {{ calc_field.name }} {
    description: "{{ calc_field.description | escape_quotes }}"
    {% if calc_field.datatype == 'string' %}
    type: string
    {% elif calc_field.datatype == 'integer' %}
    type: number
    {% elif calc_field.datatype == 'real' %}
    type: number
    {% elif calc_field.datatype == 'boolean' %}
    type: yesno
    {% else %}
    type: string
    {% endif %}
    sql: {{ calc_field.sql }} ;;
    {% if calc_field.migration_error %}
    # {{ calc_field.migration_comment | single_line_comment }}
    {% elif calc_field.original_formula %}
    # Original Tableau formula: {{ calc_field.original_formula | single_line_comment }}
    {% endif %}
  }
  {% else %}
  measure: {{ calc_field.name }} {
    description: "{{ calc_field.description | escape_quotes }}"
    {% if calc_field.is_two_step_measure %}
    type: sum
    sql: ${{ '{' + calc_field.references_dimension + '}' }} ;;
    {% elif calc_field.lookml_type %}
    type: {{ calc_field.lookml_type }}
    sql: {{ calc_field.sql }} ;;
    {% elif calc_field.datatype == 'integer' or calc_field.datatype == 'real' %}
    type: sum
    sql: {{ calc_field.sql }} ;;
    {% else %}
    type: sum
    sql: {{ calc_field.sql }} ;;
    {% endif %}
    {% if calc_field.migration_error %}
    # {{ calc_field.migration_comment | single_line_comment }}
    {% elif calc_field.original_formula %}
    # Original Tableau formula: {{ calc_field.original_formula | single_line_comment }}
    {% endif %}
  }
  {% endif %}
  {% endfor %}
  {% endif %}

  # Measures
  {% if has_measures %}
  {% for measure in measures %}

  measure: {{ measure.name | clean_name }} {
    {% if measure.description %}
    description: "{{ measure.description | escape_quotes }}"
    {% endif %}
    {% if measure.aggregation == 'sum' %}
    type: sum
    sql: ${TABLE}.{{ (measure.sql_column or measure.name) | sql_column }} ;;
    {% elif measure.aggregation == 'count' %}
    type: count
    {% if measure.sql_column %}
    sql: ${TABLE}.{{ measure.sql_column | sql_column }} ;;
    {% endif %}
    {% elif measure.aggregation == 'count_distinct' %}
    type: count_distinct
    sql: ${TABLE}.{{ (measure.sql_column or measure.name) | sql_column }} ;;
    {% elif measure.aggregation == 'average' %}
    type: average
    sql: ${TABLE}.{{ (measure.sql_column or measure.name) | sql_column }} ;;
    {% elif measure.aggregation == 'min' %}
    type: min
    sql: ${TABLE}.{{ (measure.sql_column or measure.name) | sql_column }} ;;
    {% elif measure.aggregation == 'max' %}
    type: max
    sql: ${TABLE}.{{ (measure.sql_column or measure.name) | sql_column }} ;;
    {% else %}
    type: sum
    sql: ${TABLE}.{{ (measure.sql_column or measure.name) | sql_column }} ;;
    {% endif %}
    {% if measure.value_format %}
    value_format: "{{ measure.value_format }}"
    {% endif %}
    {% if measure.hidden %}
    hidden: yes
    {% endif %}
    {% if measure.label %}
    label: "{{ measure.label | escape_quotes }}"
    {% endif %}
    {% if measure.group_label %}
    group_label: "{{ measure.group_label | escape_quotes }}"
    {% endif %}
    {% if measure.drill_fields %}
    drill_fields: [{{ measure.drill_fields | join(', ') }}]
    {% endif %}
  }
  {% endfor %}
  {% endif %}

  # Basic measures for counting
  measure: count {
    type: count
    description: "Count of records"
  }

}
